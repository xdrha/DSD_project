<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Messenger</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../bower_components/font-awesome/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="../bower_components/Ionicons/css/ionicons.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../dist/css/AdminLTE.min.css">
  <link rel="stylesheet" href="../dist/css/skins/skin-blue.min.css">
  <!-- Google Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">

  <style>
    html {
      --scrollbarBG: #444444;
      --thumbBG: #3c8dbc;
    }

    .sidebar-menu>li.contact{
      width: 11px;
    }

    .messenger::-webkit-scrollbar {
      width: 11px;
    }

    .messenger::-webkit-scrollbar-track {
      background: var(--scrollbarBG);
    }

    .messenger::-webkit-scrollbar-thumb {
      background-color: var(--thumbBG);
      border-radius: 6px;
      border: 3px solid var(--scrollbarBG);
    }

    .messenger {
      overflow-y: auto;
      flex-grow: 1;
      flex-shrink: 1;
      flex-basis: auto;
      width: 100%;
      margin-right: 0;
      border-width: 10;
      max-height: 79vh;
      min-height: 79vh;
      padding: 0 1vh;
      scrollbar-width: thin;
      scrollbar-color: var(--thumbBG) var(--scrollbarBG);
    }

    .messenger>ul {
      display: flex;
      flex-direction: column;
      list-style: none;
      padding-left: 0px;
    }

    .messenger>ul>li {
      margin: 1rem 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      max-width: 25vw;
      border-radius: 20px;
      background-color: #444444;
      box-shadow: 5px 5px 35px -30px rgba(255, 255, 255, 0.75);
      color: #ffffff;
    }

    .messenger>ul>li>small {
      margin-top: .5rem;
      color: #ffffff;
      visibility: hidden;
    }

    .messenger>ul>li.me {
      align-self: flex-end;
      background-color: #3c8dbc;
      position: relative;
      color: #ffffff;
    }

    .messenger>ul>li.me>small {
      align-self: flex-end;
      color: #ffffff;
      visibility: hidden;
    }

    .messenger>ul>li.me>small>span {
      color: rgb(5, 144, 20);
      margin-right: .75rem;
      font-weight: bold;
    }

    .messenger>ul>li.me>p>button {
      background-color: transparent;
      color: red;
      font-size: 20px;
      padding: 0;
      position: absolute;
      top: .5rem;
      right: .5rem;
      visibility: hidden;
    }

    .messenger>ul>li.me:hover>p>button{
      visibility: visible;
    }

    .messenger>ul>li:hover>h4>button{
      visibility: visible;
    }

    .messenger>ul>li.me:hover>small{
      visibility: visible;
    }

    .messenger>ul>li:hover>small{
      visibility: visible;
    }

    .messenger>ul>li>h4>button {
      background-color: transparent;
      color: red;
      font-size: 20px;
      padding: 0;
      align-self: flex-end;
      float: right;
      visibility: hidden;
    }

    .messenger>ul>li>p {
      margin: 0;
      display: inline;
      padding-right: .5rem;
      font-size: 17px;
    }

    .messenger>ul>li.me>p {
      margin: 0;
      display: inline;
      padding-right: 2rem;
    }

    .messenger>ul>li>h4 {
      margin: 0;
      display: inline-block;
    }

    div.form {
      display: flex;
      margin-top: 1rem;
      flex-direction: row;
      width: 100%;
      height: 40px;
    }

    div.form>input[type="text"] {
      flex: 1 1 auto;
      padding: 1rem;
      background-color: rgb(255, 255, 255);
      color: black;
      border: 0;
      outline: none;
    }

    .modal {
      text-align: center;
      padding: 0;
    }

    .modal:before {
      content: '';
      display: inline-block;
      height: 100%;
      vertical-align: middle;
      margin-right: -4px;
    }

    .modal-dialog {
      display: inline-block;
      text-align: left;
      vertical-align: middle;
    }

    ::placeholder {
      color: #ffffff;
      opacity: .7;
    }

    .main-sidebar{
      width: 20%;
    }

    .content-wrapper{
      margin-left: 20%;
    }

    .contact-text{
      padding: 14px; 
      font-size: 15px; 
      color: #ffffff; 
      max-width: 70%; 
      overflow:hidden;
    }

    .contact-p{
      color: #ffffff; 
      font-size: 90%; 
      padding-top: 16px; 
      padding-bottom: 15px; 
      padding-right: 40px;
    }

  </style>
</head>

<body onload=getMessages() class="hold-transition skin-blue sidebar-mini">
  <div class="wrapper">

    <header class="main-header">
      <a href="index.html" class="logo" style="width: 20%;">
        <span class="logo-lg ">Messenger</span>
      </a>

      <nav class="navbar navbar-static-top" role="navigation" style="margin-left: 20%;">
        <div class="navbar-custom-menu">
          <ul class="nav navbar-nav">

            <li class="dropdown user user-menu">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" style="background-color: #367fa9;">
                <img src="../dist/img/avatar5.png" class="user-image" alt="User Image">
                <span class="hidden-xs  nejakaklasa"></span>
                <span class="hidden-xs  ip_adress"></span>
                <span><i class=" fa fa-circle text-success" style="color: #32C12C;"></i>&nbsp&nbsp&nbsp&nbspOnline</span>
              </a>
            </li>

          </ul>
        </div>
      </nav>
    </header>

    <aside class="main-sidebar">
      <section class="sidebar">
        <ul class="sidebar-menu" data-widget="tree"></ul>
      </section>
    </aside>

    <div class="content-wrapper" style="background-color: #222222;">

      <section class="content container-fluid" style="padding-top: 5px; padding-bottom: 5px; background-color: #222222;">


          <section class="content-header" style="border-bottom: 1px solid #3c8dbc; margin: 0; padding: 0;">
            <div class="search_class form" style="margin: 0; height: 50px;">
              <img src="../dist/img/avatar6.png" class="img-circle" alt="User Image" width="45" height="45" style="padding: 5px;">
              <span class="hidden-xs" style="padding: 12px; color: #ffffff;">Group chat</span>
              <p style="color: #ffffff; font-size: 90%; padding-top: 14px; padding-bottom: 14px; padding-right: 40px"><i class=" fa fa-circle text-success"></i>&nbsp&nbsp&nbsp&nbspOnline</p>
              <input type="text" name="text" value="" placeholder="Search in messages..." id="searchfield" autocomplete="off" style="color: #ffffff; background-color:#444444; margin-top: 5px; margin-bottom: 10px;"></input>
              <span class="input-group-append" style="border: 0; margin-top: 5px; margin-bottom: 10px; background-color: #444444; padding: 7px;">
                <div class=" input-group-text bg-transparent"><i class="fa fa-search" style="color: #ffffff; opacity: 0.7; font-size: 18px;"></i>
                </div>
              </span>
            </div>
          </section>

          <div class="messenger">
            <ul></ul>

            <div class="modal fade" id="message_remove_dialog" role="dialog">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Remove message?</h4>
                  </div>
                  <div class="modal-body">
                    <p>Message will be removed for all users.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="window.message_id_to_delete = '';">Dismiss</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="remove_message(window.message_id_to_delete)">Remove</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal fade" id="contact_remove_dialog" role="dialog">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Remove contact?</h4>
                  </div>
                  <div class="modal-body">
                    <p>Contact will be removed from your contact list.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="window.contact_id_to_delete = '';">Dismiss</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="remove_contact(window.contact_id_to_delete)">Remove</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal fade" id="fail_dialog" role="dialog">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Error adding contact!</h4>
                  </div>
                  <div class="modal-body">
                    <p>Contact is not available. Be sure that IP adress is correct.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" >OK</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal fade" id="add_contact_dialog" role="dialog">
              <div class="modal-dialog">     
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Create new contact</h4>
                  </div>
                  <div class="modal-body">
                    <label for="fname">IP address:</label><br>
                    <input type="text" id="ip_address" name="ipadress"><br>
                    <label for="lname">Username:</label><br>
                    <input type="text" id="username" name="username">
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="add_contact()">Add contact</button>
                  </div>
                </div>      
              </div>
            </div>
          </div>

          <div class="form" method="POST">
            <input type="text" name="message" placeholder="Type a message..." id="message_input" autocomplete="off" style="background-color: #444444; color:#ffffff;" />
            <input type="hidden" name="name" value="kokotina>" />
            <span class="input-group-append" aria-hidden="true" style="background-color: #444444; ">
              <div class=" input-group-text bg-transparent"><i class="glyphicon glyphicon-send" style="font-size: 25px; padding: 8px; min-width: 50px; color: #3c8dbc; "></i>
              </div>
            </span>
          </div>

      </section>

    </div>


    <footer class="main-footer" style="margin-left: 20%; padding:5px; border: 0; background-color: #222d32; color: #ffffff; opacity: 0.7;">
      <strong>Copyright &copy; 2020 Matej Drha</strong> All rights reserved.
    </footer>

    <div class="control-sidebar-bg"></div>

  </div>

  <script src="../bower_components/jquery/dist/jquery.min.js"></script>
  <!-- Bootstrap 3.3.7 -->
  <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <!-- DataTables -->
  <script src="../bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
  <script src="../bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
  <!-- AdminLTE App -->
  <script src="../dist/js/adminlte.min.js"></script>


  <!-- <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script> -->

  <script>
    var objDiv = document.getElementsByClassName("messenger");
    var last_uuid = '';
    window.message_id_to_delete = "";
    window.contact_id_to_delete = "";

    function remove_message(id) {

      $.ajax({
        type: "POST",
        url: 'restapi.php',
        data: JSON.stringify({
          action: 'remove_message',
          id: id
        }),
        dataType: 'aplication/json'
      }).always(function(data) {
        getMessages();
      });

    }

    function remove_contact(id) {

      $.ajax({
        type: "POST",
        url: 'restapi.php',
        data: JSON.stringify({
          action: 'remove_contact',
          id: id
        }),
        dataType: 'aplication/json'
      }).always(function(data) {
        check_contacts();
      });

    }

    function add_contact() {

      $.ajax({
        type: "POST",
        url: 'restapi.php',
        data: JSON.stringify({
          action: 'add_contact',
          ip: $("#ip_address").val(),
          username: $("#username").val()
        }),
        dataType: 'aplication/json'
      }).always(function(data) {
        var obj = JSON.parse(data.responseText);
        result = obj.result;
        if(result == "fail"){
          $("#fail_dialog").modal();
        }
        check_contacts();
      });

}

    setInterval(check_update, 1000);
    check_contacts();
    setInterval(check_contacts, 10000);

    function check_update() {
      $.ajax({
        type: "POST",
        url: "restapi.php",
        data: JSON.stringify({
          action: "get_last_uuid"
        }),
      }).done(
        function(data) {
          if (data != last_uuid && "".localeCompare($("#searchfield").val()) == 0) {
            getMessages();
          }
        });
    }

    function check_contacts(){
      $.ajax({
        type: "POST",
        url: 'restapi.php',
        data: JSON.stringify({
          action: 'get_contacts',
        }),
        dataType: 'aplication/json'
      }).always(function(data) {
        $('.sidebar-menu').html('<li class="header" style="height: 55px; padding: 20px;">Contact list</li>');
        try {
          var obj = JSON.parse(data.responseText);
          obj.contacts.forEach(function f(item, index) {
            $('.sidebar-menu').append(item);
          });
        } catch {

        }
        $('.sidebar-menu').append('<li><a style="text-align:center;" href="#" data-toggle="modal" data-target="#add_contact_dialog"><span style="padding-right:20px;" >+ Add contact</span></a></li>');
      });
    }

    $("#searchfield").keyup(function(e) {
      if (e.keyCode == 13) getMessages($("#searchfield").val());
    });

    $("#message_input").keyup(function(e) {
      if ($("#message_input").val() == '') return;
      if (e.keyCode == 13) add_message($("#message_input").val());
    });

    function add_message(message) {
      $.ajax({
        type: "POST",
        url: 'restapi.php',
        data: JSON.stringify({
          action: 'add_message',
          message: message
        }),
        dataType: 'aplication/json'
      }).always(function(data) {
        getMessages();
        $("#message_input").val('');
      });

    }

    function getMessages(search) {

      $.ajax({
        type: "POST",
        url: 'restapi.php',
        data: JSON.stringify({
          action: 'get_messages',
          search: search
        }),
        dataType: 'aplication/json'
      }).always(function(data) {
        $('.messenger > ul').html('');
        try {
          var obj = JSON.parse(data.responseText);
          last_uuid = obj.last_uuid;
          $('.nejakaklasa').html(obj.username);
          $('.ip_adress').html("&nbsp;&nbsp;&nbsp;&nbsp|&nbsp;&nbsp;&nbsp;&nbsp" + obj.ip + "&nbsp;&nbsp;&nbsp;&nbsp");
          name = obj.username;
          obj.messages.forEach(function f(item, index) {
            $('.messenger > ul').append(item);
          });
        } catch {

        }

        document.getElementById("message_input").focus();
        objDiv[0].scrollTop = objDiv[0].scrollHeight;
      });
    };
  </script>

</body>

</html>